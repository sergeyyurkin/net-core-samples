# Аутентификация в ASP.NET Core на основе Cookie

Куки (англ. cookie, буквально — печенье) — небольшой фрагмент данных, отправленный веб-сервером и хранимый на компьютере пользователя. Веб-клиент (обычно веб-браузер) всякий раз при попытке открыть страницу соответствующего сайта пересылает этот фрагмент данных веб-серверу в составе HTTP-запроса. Применяется для сохранения данных на стороне пользователя, на практике обычно используется для:

* аутентификации пользователя;
* хранения персональных предпочтений и настроек пользователя;
* отслеживания состояния сеанса доступа пользователя;
* сведения статистики о пользователях.

## Аутентификация
 
В ASP.NET Core имеется свой полноценный провайдер аутентификации - ASP.NET Core Identity, используемый для создания и поддержки учетных записей. Однако, есть возможность использовать поставщика аутентификации на основе cookie-файлов без использования ASP.NET Core Identity.

Для этого в ASP.NET определен специальный компонент middleware, который сериализует данные пользователя в зашифрованные аутентификационные куки и передает их на сторону клиента. При получении запроса от клиента, в котором содержатся аутентификационные куки, происходит их валидация, десериализация и инициализация свойства User объекта HttpContext.

В методе **ConfigureServices()** производится установка и настройка всех необходимых сервисов:

```cs
services.AddAuthentication(CookieAuthenticationDefaults.AuthenticationScheme)
    .AddCookie(options =>
    {
        options.LoginPath = new Microsoft.AspNetCore.Http.PathString("/account/login");
    });
```

Для установки аутентификации с помощью куки в вызов ```services.AddAuthentication()``` передается значение **CookieAuthenticationDefaults.AuthenticationScheme**. Далее с помощью метода **AddCookie()** настраивается аутентификация. По сути в этом методе производится конфигурация объекта **CookieAuthenticationOptions**, который описывает параметры аутентификации с помощью кук. В частности, в данном случае использовано одно свойство **CookieAuthenticationOptions** - **LoginPath**. Это свойство устанавливает относительный путь, по которому будет перенаправляться анонимный пользователь при доступе к ресурсам, для которых нужна аутентификация.

В методе **Configure()** внедряем в конвейер необходимые компоненты middleware:

```cs
app.UseAuthentication();
app.UseAuthorization();
```

Метод ```app.UseAuthentication()``` встраивает в конвейер компонент **AuthenticationMiddleware**, который управляет аутентификацией. Его вызов позволяет установить значение для свойства **HttpContext.User**. И метод app.**UseAuthorization()** встраивает в конвейер компонент **AuthorizationMiddleware**, который управляет авторизацией пользователей и разграничивает доступ к ресурсам.

```cs
private async Task Authenticate(string email)
{
    var claims = new List<Claim>
    {
        new Claim(ClaimsIdentity.DefaultNameClaimType, email)
    };

    var identity = new ClaimsIdentity(
        claims, 
        "ApplicationCookie", 
        ClaimsIdentity.DefaultNameClaimType, 
        ClaimsIdentity.DefaultRoleClaimType);

    var principal = new ClaimsPrincipal(identity);

    await HttpContext.SignInAsync(
        CookieAuthenticationDefaults.AuthenticationScheme, principal);
}
```

Для устанвки кук используется метод **HttpContext.SignInAsync()**, который принимает в качестве параметров принимает схему аутентификации (в нашем случае это строка "Cookies") и объект **ClaimsPrincipal**, который представляет пользователя.

Для создания и настройки объекта **ClaimsPrincipal** используется список claims - набор данных, которые шифруются и добавляются в аутентификационные куки. В нашем случае у нас только один claim, который в качестве типа принимает константу ClaimsIdentity.DefaultNameClaimType, а в качестве значения - email пользователя.

Далее создается объект **ClaimsIdentity**, который нужен для инициализации **ClaimsPrincipal**. В **ClaimsIdentity** передается:

* Ранее созданный список claims;
* Тип аутентификации, в данном случае ```"ApplicationCookie"```;
* Тип данных в списке claims, который преставляет логин пользователя;
* Тип данных в списке claims, который представляет роль пользователя.

И после вызова метода расширения **HttpContext.SignInAsync** в ответ клиенту будут отправляться аутентификационные куки, которые при последующих запросах будут передаваться обратно на сервер, десериализоваться и использоваться для аутентификации пользователя.

## Авторизация

Ключевым инструментом для авторизации является атрибут **AuthorizeAttribute** из пространства имен Microsoft.AspNetCore.Authorization. Для проверки статуса пользователя атрибут использует свойство **HttpContext.User**, которое устанавливается инфраструктурой ASP.NET и представляет объект интерфейса **IPrincipal**, который определен в пространстве имен System.Security.Principal. Этот интерфейс определяет метод **IsInRole()** и свойство **Identity**.

Свойство Identity возвращает объект интерфейса IIdentity, который связан с текущим запросом.

Метод IsInRole() в качестве параметра принимает роль и возвращает true, если текущий пользователь принадлежит данной роли.

Объект IIdentity, в свою очередь, предоставляет информацию о текущем пользователе через следующие свойства:

* **AuthenticationType**: тип аутентификации в строковом виде;
* **IsAuthenticated**: возвращает true, если пользователь аутентифицирован;
* **Name**: возвращает имя пользователя. Как правило, в качестве подобного имени используется логин, по которому пользователь входит в приложение.

Атрибут **AllowAnonymous** позволяет открыть доступ для анонимных пользователей. Обычно он применяется к методам контроллера, который уже защищен атрибутом Authorize.

## Claim & ClaimPrincipal

Свойство **HttpContext.User** содержит **IPrincipal**, которое фактически представляет объект класса **ClaimsPrincipal**.
В свою очередь **HttpContext.User** содержит свойство **Identity** типа **IIdentity**, которое представляет объект класса **ClaimsIdentity**.

[ClaimsPrincipal](https://docs.microsoft.com/dotnet/api/system.security.claims.claimsprincipal) предоставляет коллекцию идентификаторов, каждая из которых является ClaimsIdentity . В общем случае эта коллекция, доступ к которой осуществляется через Identities свойство, будет иметь только один элемент. Содержит свойства и методы, полезные для работы с утверждениями (Claim).

[ClaimsIdentity](https://docs.microsoft.com/dotnet/api/system.security.claims.claimsidentity) является конкретной реализацией удостоверения на основе утверждений, т.е. удостоверения, описываемого коллекцией утверждений.

[Claim](https://docs.microsoft.com/dotnet/api/system.security.claims.claim) - это утверждение сущности, созданной издателем, который описывает свойство, право или другое качество этой сущности.

Claim определяет следующие свойства:

* **Issuer**: "издатель" или название системы, которая выдала данный claim;
* **Subject**: возвращает информацию о пользователе в виде объекта ClaimsIdentity;
* **Type**: возвращает тип объекта claim;
* **Value**: возвращает значение объекта claim.

В классе ClaimsPrincipal есть следующие свойства и методы:

* **Identity**: возвращает объект ClaimsIdentity, который реализует интерфейс IIdentity и представляет текущего пользователя;
* **FindAll(type) / FindAll(predicate)**: возвращает все объекты claim, которые соответствуют определенному типу или условию;
* **FindFirst(type) / FindFirst(predicate)**: возвращает первый объект claim, который соответствуют определенному типу или условию;
* **HasClaim(type, value) / HasClaim(predicate)**: возвращает значение true, если пользователь имеет claim определенного типа с определенным значением;
* **IsInRole(name)**: возвращает значение true, если пользователь принадлежит роли с названием name.

Класс ClaimsIdentity определяет следующие свойства и методы:
* **Claims**: свойство, которое возвращает набор ассоциированных с пользователем объектов claim;
* **AddClaim(claim)**: добавляет для пользователя объект claim;
* **AddClaims(claims)**: добавляет набор объектов claim;
* **FindAll(predicate)**: возвращает все объекты claim, которые соответствуют определенному условию;
* **HasClaim(predicate)**: возвращает значение true, если пользователь имеет claim, соответствующий определенному условию;
* **RemoveClaim(claim)**: удаляет объект claim;

## Материалы

* https://ru.wikipedia.org/wiki/cookie
* https://metanit.com/sharp/aspnet5/15.1.php
* https://docs.microsoft.com/aspnet/core/security/authentication/cookie
* https://docs.microsoft.com/aspnet/core/security/authorization/claims
